<!DOCTYPE html>
<!--Message database for Web Developer Testing Program
    Prepared by Allen Jones 
    Creates an indexed database to store ckeditor input as strings
    The database entries can then be displayed as html-->

<html>
<head>
    <script src="Resources/ckeditor_4.11.2_basic/ckeditor.js"></script>
    <!-- Bootstrap requires these Libraries -->
    <script src="Resources/jquery.3.3.1/jquery.min.js"></script>
    <script src="Resources/bootstrap-4.1.3-dist/js/popper.min.js"></script>
    <!-- Style sheet -->
    <link rel="stylesheet" href="Resources/bootstrap-4.1.3-dist/css/bootstrap.min.css">
    <!--Content type to Unicode-->
    <meta http-equiv="Content-Type" content="text/html; charset = utf-8" />

    <!--Message Database-->
    <script type="text/javascript">

        //Test implementation prefixes
        window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
        window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
        window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange

        //Unsupported browser
        if (!window.indexedDB) {
            window.console.log("Your browser doesn't support a stable version of IndexedDB.")
        }

        //Declare database
        var messageData = [];
        var msgDataBase;
        var request = window.indexedDB.open("newDatabase", 1);
        //Check if a messageData.size cookie exists, if so, set it
        checkDatabase();

        //Error handling
        request.onerror = function (event) {
            console.log("error: " + request.error);
        };
        request.onsuccess = function (event) {
            //Request successful, Define msgDataBase
            msgDataBase = request.result;
            console.log("success: " + msgDataBase);
        };
        
        //Init database in memory
        request.onupgradeneeded = function (event) {
            console.log("Upgrading... ");
            var msgDataBase = event.target.result;
            var objectStore = msgDataBase.createObjectStore("messages", { keyPath: "id" });
        }

        //Set  a cookie, used for database size
        function setCookie(cookieName, cookieValue, cookieExpDays) {
            //Init
            var date = new Date();
            //Calculate time in miliseconds, not accounting for all factors
            date.setTime(date.getTime() + (cookieExpDays * 24 * 60 * 60 * 1000));
            //convert the time to Univeral Time Standard
            var expires = "expires=" + date.toUTCString();
            //create cookie in memory
            document.cookie = cookieName + "=" + cookieValue + ";" + expires + ";path=/";
        }
        //Read a cookies value
        function getCookie(cookieName) {
            //Init
            var cookieInit = cookieName + "=";
            //Decode for special characters
            var cookieDecoded = decodeURIComponent(document.cookie);
            //Split off the expiration date
            var cookieSplit = cookieDecoded.split(';');
            //Cycle cookie characters to remove whitespace
            for (var i = 0; i < cookieSplit.length; i++) {
                var cookieTrim = cookieSplit[i];
                //whitespace remover
                while (cookieTrim.charAt(0) == ' ') {
                    cookieTrim = cookieTrim.substring(1);
                }
                //return trimmed cookie
                if (cookieTrim.indexOf(cookieInit) == 0) {
                    return cookieTrim.substring(cookieInit.length, cookieTrim.length);
                }
            }
            //default return, blank
            return "";
        }

        //Check if cookie exists, if not, create one and set it and messageData.size both to 0;
        function checkDatabase() {
            //Init
            var cookie = getCookie("MessageDataSize");
            //Cookie exists, set messageData.size
            if (cookie != "") {
                messageData.size = MessageDataSize
            }
            //no cookie, set one to 0 and set messageData.size to 0
            else {
                //Failsafe.. Unecessary
               // if (cookie != "" && cookie != null) {
                    setCookie("MessageDataSize", 0, 365);
                    messageData.size = 0;
               // }
            }
        }

        //Functions:
        //Add: adds a postMessage to database. take sin MessageDataSize, ckeditor data, and date
        function addPost(userName, msgString, date) {

            //Init Post to be added
            var newPost = [{ id: messageData.size, userName: userName, msgString: msgString, date: date }];
            var transaction = msgDataBase.transaction(["messages"], "readwrite");

            //Error handling
            transaction.onerror = function (event) {
                console.log("Error, Not opened: " + transaction.error + " -> newPost id: " + newPost[0].id +
                    " -> database size: " + messageData.size);
            };

            // Init object store
            var objectStore = transaction.objectStore("messages");
            var objectStoreRequest = objectStore.add(newPost[0]);

            //Error handling
            objectStoreRequest.onsuccess = function (event) {
                console.log("Item added. -> newPost id: " + newPost[0].id + " -> database size: " + messageData.size);
                //Increment messageData.size and store cookie for it
                messageData.size++;
                setCookie("messageDatSize", messageData.size, 30)
            };
            objectStoreRequest.onerror = function (event) {
                console.log("Item Not Added. Error: " + objectStoreRequest.error + " -> newPost id: " + newPost[0].id + " -> database size: " + messageData.size);
            };
        }

        //Deletes the most recent post
        function deletePost() {
            //Delete post
            if (messageData.size > 0) {
                var request = msgDataBase.transaction(["messages"], "readwrite")
                    .objectStore("messages")
                    .delete((messageData.size - 1).toString(2));

                //Error handling
                request.onsuccess = function (event) {
                    console.log("the last entry has been removed from your database.");
                    //decrement data size and store cookie
                    messageData.size--;
                    setCookie("messageDatSize", messageData.size, 30)
                };
                request.onerror = function (event) {
                    console.log("error: " + request.error);
                };

            }
            else
                console.log("Nothing to be removed.");
        }

        //Clear database
        function clearPosts() {
            //Clear database
            var request = msgDataBase.transaction(["messages"], "readwrite")
                .objectStore("messages")
                .clear();
            messageData.size = 0;
            setCookie("messageDatSize", messageData.size, 30)
            //Error handling
            request.onsuccess = function (event) {
                console.log("all data removed from database");
            };
            request.onerror = function (event) {
                console.log("error: " + request.error);
            };

        }

        //The 'Display Post' Button, Displays all current database entries in html
        function displayPost() {
            //Display each message
            console.log("Displaying Post...");
            for (i = 0; i < messageData.size; i++) {
                console.log("Message: " + i);
                //if (messageData.size > 0) {
                var request = msgDataBase.transaction(["messages"])
                    .objectStore("messages");
                        //.delete((messageData.size - 1).toString(2));
                //var request = msgDataBase.transaction(["messages"])
                 //   .objectStore = request.objectStore("messages");
                //var request = objectStore.get(messageData[i]);

                //Error handling
                request.onerror = function (event) {
                    console.log("Error :" + request.error);
                };
                request.onsuccess = function (event) {
                    //Display database as html
                    console.log("Success, appending...");
                    $("#PostArea").append(
                        "<p> Post ID: " + request.result.id +
                        " - Username: " + request.result.userName +
                        " - Message: " + request.result.msgString +
                        " - Date: " + request.result.date +
                        "</p>");
                    $("#PostArea").append("<hr />")
                };

            }
        }

    </script>
</head>
<body>

    <!--The area of html that will be appended when a post is displayed-->
    <div id="PostArea"></div>

    <!--The area that is replaced by ckeditor-->
    <form>
        <textarea name="editor1" id="editor1" rows="10" cols="80">
                Create your message here. 
                    The 'clearPosts database' is important if you've revisited the page,  as it's only Partially persistent. 
                    'deletePost' deletes the most recent entry. 
                    'Post' adds the data to the database. 
                    'displayPost' adds them to the html for viewing
            </textarea>
        <script>
            // Replace the <textarea id="editor1"> with a CKEditor
            // instance, using default configuration.
            CKEDITOR.replace('editor1');

            //The 'Post Message' Button, Adds ckeditor data to database
            function postMessage() {
                const editorData = CKEDITOR.instances.editor1.getData();
                console.log(editorData);
                addPost("MessageDataSize", editorData, "fake")


            }

            
        </script>
    </form>

    <!--Buttons used-->
    <button onclick="displayPost()">Display Post</button>
    <button onclick="postMessage()">Post Message</button>
    <button onclick="deletePost()">delete Post</button>
    <button onclick="clearPosts()">Clear All Posts</button>

</body>
</html>
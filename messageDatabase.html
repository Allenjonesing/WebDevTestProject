<!DOCTYPE html>
<!--Message database for Web Developer Testing Program
    Prepared by Allen Jones
    Creates an indexed database to store ckeditor input as strings
    The database entries can then be displayed as html

    The database is persistant through browser close. Messages are displayed
    through html appendages, and removed and re-appended during each visit, post, and deletion.

    Functions
    addPost - Intakes username, ckeditor data, and the current date
    and adds this info to the IDB. The database is counted to determine the next
    id number.

    deletePost - Intakes the post id from the delete post button and deletes the
    appropriate post. Then calls displayPost to reset the posts on screen

    postMessage - The function for the Post Message Button. Calls addPost
    to add the ckeditor data to the database. THen calls displayPost to reset 
    the posts on screen

    displayPost - Removes all content in the postarea element, then appends all
    posts through the database using a cursor. 

    -->

<html>
<head>
    <!--ckeditor resourses-->
    <script src="Resources/ckeditor_4.11.2_basic/ckeditor.js"></script>
    <!-- Bootstrap requires these Libraries -->
    <script src="Resources/jquery.3.3.1/jquery.min.js"></script>
    <script src="Resources/bootstrap-4.1.3-dist/js/popper.min.js"></script>
    <!-- Bootstrap style sheet -->
    <link rel="stylesheet" href="Resources/bootstrap-4.1.3-dist/css/bootstrap.min.css">
    <!--Unicode content-->
    <meta http-equiv="Content-Type" content="text/html; charset = utf-8" />

    <script type="text/javascript">

        //Test implementation prefixes
        window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
        window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
        window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange

        //Unsupported browser
        if (!window.indexedDB) {
            window.console.log("Your browser doesn't support a stable version of IndexedDB.")
        }

        //Declare database and open
        var messageData = [];
        var db;
        var request = window.indexedDB.open("messages", 1);

        //Error handling
        request.onerror = function (event) {
            console.log("error: " + request.error);
        };

        //Successful open of database, set it and open object store
        request.onsuccess = function (event) {
            db = request.result;
            //reset pastarea element so that existing posts appear on page load
            displayPost();
            var transaction = db.transaction("messages");
            var objectStore = transaction.objectStore("messages");
            console.log("success: " + db);
            //Count the database to determin next id
            var countRequest = objectStore.count();
            countRequest.onsuccess = function () {
                console.log(countRequest.result);
                messageData.size = countRequest.result;
            }
        };

        //Init database in memory
        request.onupgradeneeded = function (event) {
            console.log("Upgrading... ");
            var db = event.target.result;
            var objectStore = db.createObjectStore("messages", { keyPath: "id" });

        }



        //Functions:
        //Add: adds a postMessage to database. take sin username, ckeditor data, and date
        function addPost(userName, msgString, date) {

            //Init
            var transaction = db.transaction(["messages"], "readwrite");

            //Error handling
            transaction.onerror = function (event) {
                console.log("Error, Not opened: " + transaction.error + " -> newPost id: " + newPost[0].id +
                    " -> database size: " + messageData.size);
            };

            // Init object store
            var objectStore = transaction.objectStore("messages");

            //Count the database to determin next id
            var countRequest = objectStore.count();
            countRequest.onsuccess = function () {
                console.log(countRequest.result);
                messageData.size = countRequest.result;
            }

            //Init and add post
            var newPost = [{ id: messageData.size, userName: userName, msgString: msgString, date: date }];
            var objectStoreRequest = objectStore.add(newPost[0]);

            //Error handling
            objectStoreRequest.onsuccess = function (event) {
                console.log("Item added. -> newPost id: " + newPost[0].id + " -> database size: " + messageData.size);
                messageData.size++;
                displayPost();
            };
            objectStoreRequest.onerror = function (event) {
                console.log("Item Not Added. Error: " + objectStoreRequest.error + " -> newPost id: " + newPost[0].id + " -> database size: " + messageData.size);
            };
        }

        //Deletes the most recent post
        function deletePost(postId) {
            //Delete post
            console.log("Delete")
            var request = db.transaction(["messages"], "readwrite")
                .objectStore("messages")
                .delete(postId);

            //Error handling
            request.onsuccess = function (event) {
                console.log("post removed from your database.");
                messageData.size--;
                displayPost();
            };
            request.onerror = function (event) {
                console.log("error: " + request.error);
            };

        }
    </script>
</head>
<body>

    <!--The area of html that will be appended when a post is displayed-->
    <div class="container">
        <div class="card">
            <div id="PostArea"></div>
        </div>
    </div>
    <!--The area that is replaced by ckeditor-->
    <form>
        <textarea name="editor1" id="editor1" rows="10" cols="80">
                Create your message here. Push "Post Button" to post it and have it displayed. 
                    All user messages go here, and can be deleted individually.
                    This data will persist after the browser is closed.
            </textarea>
        <script>
            // Replace the <textarea id="editor1"> with a CKEditor
            // instance, using default configuration.
            CKEDITOR.replace('editor1');

            var username = window.location.hash.substring(1)

            //The 'Post Message' Button, Adds ckeditor data to database
            function postMessage() {
                //Get todays date
                var today = new Date();
                //Format it the way we like
                var dd = today.getDate();
                var mm = today.getMonth() + 1;
                var yyyy = today.getFullYear();
                //capture ckeditor data
                const editorData = CKEDITOR.instances.editor1.getData();
                console.log(editorData);
                //addPost with this collected data
                addPost(("User: " + username), editorData, ("Date Posted: " + (mm + " / " + dd + " / " + yyyy)));


            }

            // Displays all current database entries in html
            function displayPost() {
                //Display each message
                console.log("Displaying...");

                //Init
                var transaction = db.transaction(["messages"]);
                var objectStore = transaction.objectStore("messages");
                //Remove all content to post it with changes
                $("#PostArea").empty();
                objectStore.openCursor().onsuccess = function (event) {

                    //Use cursor to cycle all entries, displaying each one in a lisr
                    var cursor = event.target.result;
                    if (cursor) {
                        var listItem = document.createElement("li");
                        //This is our post, passing the post id to the delete button for each post
                        listItem.innerHTML =
                            cursor.value.userName
                            + "<br>"
                            + cursor.value.msgString
                            + "<br>"
                            + cursor.value.date
                            + "<br>"
                            + "<button onclick='deletePost("
                            + cursor.value.id
                            + ") '>delete Post</button>"
                            + "<br><br>";
                        //add these appendages to the html
                        $("#PostArea").append(listItem);
                        cursor.continue();
                    } else {
                        console.log('all Entries displayed.');
                    }
                };
            }
        </script>
    </form>

    <!--Button used-->
    <button onclick="postMessage()">Post Message</button>

</body>
</html>
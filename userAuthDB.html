<!DOCTYPE html>
<!--User Authentication database-->
<html>
<head>
	<!--Required libraries for ckeditor, jquery, and bootstrap-->
	<script src="Resources/ckeditor_4.11.2_basic/ckeditor.js"></script>
	<script src="Resources/jquery.3.3.1/jquery.min.js"></script>
	<script src="Resources/bootstrap-4.1.3-dist/js/popper.min.js"></script>

	<!--Set Content type-->
	<meta http-equiv="Content-Type" content="text/html; charset = utf-8" />
	<script type="text/javascript">

		//test implementation prefixes
        window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;

        // window.IDB objects' prefixes
        window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
        window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange

        //Unsupported browser
        if (!window.indexedDB) {
            window.console.log("Your browser doesn't support a stable version of IndexedDB.")
        }

        
        //if (document.cookie == "")
        //    document.cookie = 0;
        var userData = [
          //  { id: 0, userName: "default name", msgString: "default msg", date: "default date" }
        ];

        //database creation request
        var data;
        var request = window.indexedDB.open("newDatabase", 1);
        //userData.size = document.cookie;
        //console.log(document.cookie)

        //database failed
        request.onerror = function (event) {
            console.log("error: " + request.error);
        };

        //Database created
        request.onsuccess = function (event) {
            data = request.result;
            console.log("success: " + data);
        };

        //check for upgrades
        request.onupgradeneeded = function (event) {
            console.log("Upgrading... ");

            //Create Object Store
            var data = event.target.result;
            var objectStore = data.createObjectStore("user", { keyPath: "id", autoIncrement: true });

            //Init Object Store
            for (var i in userData) {
                objectStore.add(userData[i]);
            }
        }

        //Create new account, add user input to database
        function register(username, password) {
            // Create a new object ready to insert into the IDB
            //console.log(userData.size);
            var user = [{ id: userData.size, username: username, password: password }];

            // open a read/write data transaction, ready for adding the data
            var transaction = data.transaction(["user"], "readwrite");

            // report on the success of the transaction completing, when everything is done
            transaction.onsuccess = function (event) {
                console.log("Transaction Complete!");
            };

            transaction.onerror = function (event) {
                console.log("Error, Not opened: " + transaction.error + " -> newItem id: " + newItem[0].id + " -> database size: " + userData.size);
            };

            // create an object store on the transaction
            var objectStore = transaction.objectStore("user");

            // Make a request to add our newItem object to the object store
            var objectStoreRequest = objectStore.add(newItem[0]);

            objectStoreRequest.onsuccess = function (event) {
                // report the success of our request
                console.log("Item added. -> newItem id: " + newItem[0].id + " -> database size: " + userData.size);
                userData.size++;
                //var getActive = browser.tabs.query({ active: true, currentWindow: true });
                //getActive.then(setCookie);
                //document.cookie = userData.size.toString();


            };
            objectStoreRequest.onerror = function (event) {
                // report the error of our request
                console.log("Item Not Added. Error: " + objectStoreRequest.error + " -> newItem id: " + newItem[0].id + " -> database size: " + userData.size);

            };


            request.onerror = function (event) {
                console.log("error: " + request.error + " -> newItem id: " + newItem.id + " -> database size: " + userData.size);
            }
        }

        //Login to existing account, search database for user input
        function login(username, password) {

        }

        //create new password, edit database entry after answering security question
        /*function forgotPass() {

        }*/
	</script>
</head>
	</html>

<!DOCTYPE html>
<!--Home page for Wed Developer Testing Project.
    Prepared by Allen Jones
    Uses Bootstrap Modals for login and register forms
    Adds input data from registration into indexed database
    References database for password check, proceeds to profile page

    The database is persistant through browser close. No accounts exist at first


    Functions
    legister - Takes user input for username and password
    adds info to indexed database, handles errors

    login - Takes user input for username and password
    attempts to reference input password with database entry matching username
    this poses security risks, allowing password to be viewed in debugging.

    goToProfile - Sends user to the messageDatabase.html and passes their username along

    -->


<html lang="en">
<head>
    <!--Unicode-->
    <meta charset="utf-8" />
    <!--Responsive viewpoint-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap style sheet -->
    <link rel="stylesheet" href="Resources/bootstrap-4.1.3-dist/css/bootstrap.min.css">

    <!--Sets page title-->
    <title>Allen Jones - WebDeveloperTestingProject</title>
</head>
<body>
    <!--Your HTML content here-->
    <!--Display welcome screen-->
    <div class="container">
        <div class="welcome">
            <h1><img id="Jimg" src="jimg.png" height="100" width="100" /> Welcome!</h1>
            <h2>This is the home page for Web Developer Testing Program</h2>
            <h3>There are no existing accounts, please create one and then log in.</h3>
        </div> <!--End "welcome"-->
        <!--Login, Register Buttons, assigned to open Modals-->
        <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#loginModal">Log In</button>
        <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#registerModal">Register</button>

        <!--Login Modal-->
        <div id="loginModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <!--Greet user with instructions and offer close and register buttons-->
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <button type="button" class="register" data-target="#registerModal">&times;</button>
                        <!--User instructions-->
                        <h4 calss="modal-title">Log in, or create an account.</h4>
                    </div>  <!--End modal-header-->
                    <div class="modal-body">
                        <!--Neatly display login forms-->
                        <table>
                            <tbody>
                                <tr>
                                    <td>
                                        <!--username input field-->
                                        <input type="text" id="usernameText" placeholder="Username" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <!--error message, like "Enter username"-->
                                        <span id="usernameSpan"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <!--Password input field-->
                                        <input type="text" id="passwordText" placeholder="Password" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <!--error message, like "Enter password"-->
                                        <span id="passwordSpan"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <!--Login button-->
                                        <input type="button" id="loginButton" value="Login" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <!--Error message other-->
                                        <span id="errorSpan"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <img id="loadingImg" src="loading.gif" />
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>  <!--End "modal-body"-->
                    <div class="modal-footer">
                        <!--close button for login Modal-->
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>  <!--End "modal-footer"-->
                </div>      <!--End "modal-content"-->
            </div>          <!--End "modal-dialog"-->
        </div>              <!--End "login modal"-->
        <!--Register Modal-->
        <div id="registerModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <!--close button for Register Modal-->
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Register a Username and Password</h4>
                    </div>
                    <div class="modal-body">
                        <table>
                            <tbody>
                                <tr>
                                    <td>
                                        <!--username-->
                                        <input type="text" id="regUsernameText" placeholder="Username" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span id="regUsernameSpan"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="text" id="regPasswordText" placeholder="Password" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span id="regPasswordSpan"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="text" id="regRptPasswordText" placeholder="Repeat Password" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span id="regRptPasswordSpan"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="button" id="registerButton" value="Register" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span id="regErrorSpan"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <img id="regLoadingImg" src="loading.gif" />
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>  <!--End "Modal-footer-->
                </div>      <!--End "modal-content"-->
            </div>          <!--End "modal-dialog-->
        </div>              <!--End "modal-Modal-->
    </div>                  <!--End "container"-->
    <!-- Bootstrap requires these Libraries -->
    <script src="Resources/jquery.3.3.1/jquery.min.js"></script>
    <script src="Resources/bootstrap-4.1.3-dist/js/popper.min.js"></script>

    <!-- Bootstrap JS Library -->
    <script src="Resources/bootstrap-4.1.3-dist/js/bootstrap.min.js"></script>

    <!-- CKEditor JS Library -->
    <script src="Resources/ckeditor_4.11.2_basic/ckeditor.js"></script>

    <!-- Your application javascript --------------------------------------->
    <script type="text/javascript">
        //test implementation prefixes
        window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
        window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
        window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange

        //Unsupported browser
        if (!window.indexedDB) {
            window.console.log("Your browser doesn't support a stable version of IndexedDB.")
        }

        //declare database and open
        var userData = [];
        var data;
        var request = window.indexedDB.open("users", 1);
        //userData.size = 0;
        //error handling
        request.onerror = function (event) {
            console.log("error: " + request.error);
        };
        request.onsuccess = function (event) {
            data = request.result;
        };

        //check for upgrades, a new databse is created
        request.onupgradeneeded = function (event) {
            //Create Object Store
            var data = event.target.result;
            var objectStore = data.createObjectStore("users", { keyPath: "username" });
            //Count the database to determin next id
            var countRequest = objectStore.count();
            countRequest.onsuccess = function () {
                console.log(countRequest.result);
                userData.size = countRequest.result;
            }
        }

        //hide loading images
        $("#loadingImg").hide();
        $("#regLoadingImg").hide();

        //Create new account, add user input to database
        function register(username, password) {

            //Init
            var transaction = data.transaction(["users"], "readwrite");

            //Error handling
            transaction.onerror = function (event) {
                console.log("Error, Not opened: " + transaction.error +
                    " -> newItem id: " + newUser[0].id + " -> database size: " + userData.size);
            };
            //Init Object Store of
            var objectStore = transaction.objectStore("users");

            //Count the database to determin next id
            var countRequest = objectStore.count();
            countRequest.onsuccess = function () {
                console.log(countRequest.result);
                userData.size = countRequest.result;
            }

            //Init and add new user
            var newUser = [{ username: username, id: userData.size, password: password }];
            var objectStoreRequest = objectStore.add(newUser[0]);

            //Error handling
            objectStoreRequest.onsuccess = function (event) {
                console.log("User added. -> newItem id: " + newUser[0].id + " -> database size: " + userData.size);
                $("#regErrorSpan").text("Registration successful! ");
                //$("#regLoadingImg").show();
                //setTimeout(refresh(), 2);
                userData.size++;
            };
            objectStoreRequest.onerror = function (event) {
                $("#regErrorSpan").text(objectStoreRequest.error);
            };
        } //End Register()

        //Login to existing account, search database for user input
        function login(username, password) {
            //Init database to reference
            var transaction = data.transaction(["users"]);
            var objectStore = transaction.objectStore("users");
            var request = objectStore.get(username);

            //Successful find of username
            request.onsuccess = function (event) {
                if (request.result) {
                    //Check password using strict compare
                    if (request.result.password === password) {
                        $("#loadingImg").show();
                        setTimeout(goToProfile(username), 1500);
                    }
                    else {
                        //No match to databse
                        $("#errorSpan").text("Incorrect Password");
                    }
                }
                else {
                    //No match for username
                    $("#errorSpan").text("Username not found");
                    console.log("ERROR, wrong username")

                }

            };

            //Error handling
            request.onerror = function (event) {
                $("#ErrorSpan").text("error: " + request.error);
            };
        }//End Login()

        //Check input areas for errors
        $("#loginButton").click(function (e) {
            console.log("login pressed");
            //Ensure user entered a value
            if ($("#usernameText").val() == "")
                $("#usernameSpan").text("Enter Username");
            else
                $("#usernameSpan").text("");
            //Ensure user entered a value
            if ($("#passwordText").val() == "")
                $("#passwordSpan").text("Enter Password");
            else
                $("#passwordSpan").text("");
            //Both fields have values, attempt to login
            if (($("#usernameText").val() != "") && ($("#passwordText").val() != "")) {
                login($("#usernameText").val(), $("#passwordText").val());
            }
        });

        //Check input areas for errors
        $("#registerButton").click(function (e) {
            console.log("register pressed");
            //Ensure user entered a value
            if ($("#regUsernameText").val() == "")
                $("#regUsernameSpan").text("Enter Username");
            else
                $("#regUsernameSpan").text("");
            //Ensure user entered a value
            if ($("#regPasswordText").val() == "")
                $("#regPasswordSpan").text("Enter Password");
            else
                $("#regPasswordSpan").text("");
            //Ensure user entered a value
            if ($("#regRptPasswordText").val() == "")
                $("#regRptPasswordSpan").text("Retype Password");
            //Ensure user entered matching passwords
            else if ($("#regRptPasswordText").val() != $("#regPasswordText").val())
                $("#regRptPasswordSpan").text("No Match!");
            //All criteria meet, attept to register
            else if (($("#regUsernameText").val() != "") && ($("#regPasswordText").val() != "") && ($("#regRptPasswordText").val() != "")) {
                $("#regRptPasswordSpan").text("");
                register($("#regUsernameText").val().trim(), $("#regPasswordText").val().trim());
            }
        });//End register()

        //Go to profile page
        function goToProfile(username) {
            //pass username data along
            window.location.href = "messageDatabase.html" + '#' + username;
        }
    </script> <!--End Script-->
</body>
</html>

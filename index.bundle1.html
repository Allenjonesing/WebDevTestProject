<!DOCTYPE html>
<!--Home page for Wed Developer Testing Project. 
    Prepared by Allen Jones
    Uses Bootstrap Modals for login and register forms
    Adds input data from registration into indexed database
    References database for password check, proceeds to profile page-->

<html lang="en" >
<head>
    <!--Unicode-->
    <meta charset="utf-8" />
    <!--Responsive viewpoint-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap style sheet -->
    <link rel="stylesheet" href="Resources/bootstrap-4.1.3-dist/css/bootstrap.min.css">


    <title>Allen Jones - WebDeveloperTestingProject</title>
</head>
<body>
    <!--Your HTML content here-->
    <!--Display welcome screen-->
    <div class="container">
        <div class="welcome">
            <h1>Welcome!</h1>
            <h2>This is the home page for Web Developer Testing Program</h2>
            <h3>There are no esisting accounts, please create one and then log in.</h3>
        </div> <!--End "welcome"-->
        <!--Login, Register Buttons-->
        <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#loginModal">Log In</button>
        <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#registerModal">Register</button>

        <!--Login Modal-->
        <div id="loginModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <!--Greet user with instructions and offer close and register buttons-->
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <button type="button" class="register" data-target="#registerModal">&times;</button>
                        <h1 class="modal-title">Log in</h1>
                        <h2 calss="modal-title">, or create an account.</h2>
                    </div>  <!--End modal-header-->
                    <div class="modal-body">
                        <!--Neatly display login forms-->
                        <table>
                            <tbody>
                                <tr>
                                    <td>
                                        <input type="text" id="usernameText" placeholder="Username" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span id="usernameSpan"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="text" id="passwordText" placeholder="Password" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span id="passwordSpan"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="button" id="loginButton" value="Login" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span id="errorSpan"></span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>  <!--End "modal-body"-->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>  <!--End "modal-footer"-->
                </div>      <!--End "modal-content"-->
            </div>          <!--End "modal-dialog"-->
        </div>              <!--End "login modal"-->
        <!--Register Modal-->
        <div id="registerModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Register a Username and Password</h4>
                    </div>
                    <div class="modal-body">
                        <table>
                            <tbody>
                                <tr>
                                    <td>
                                        <input type="text" id="regUsernameText" placeholder="Username" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span id="regUsernameSpan"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="text" id="regPasswordText" placeholder="Password" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span id="regPasswordSpan"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="text" id="regRptPasswordText" placeholder="Repeat Password" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span id="regRptPasswordSpan"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="button" id="registerButton" value="Register" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span id="regErrorSpan"></span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>  <!--End "Modal-footer-->
                </div>      <!--End "modal-content"-->
            </div>          <!--End "modal-dialog-->
        </div>              <!--End "modal-Modal-->
    </div>                  <!--End "container"-->

    <!-- Bootstrap requires these Libraries -->
    <script src="Resources/jquery.3.3.1/jquery.min.js"></script>
    <script src="Resources/bootstrap-4.1.3-dist/js/popper.min.js"></script>

    <!-- Bootstrap JS Library -->
    <script src="Resources/bootstrap-4.1.3-dist/js/bootstrap.min.js"></script>

    <!-- CKEditor JS Library -->
    <script src="Resources/ckeditor_4.11.2_basic/ckeditor.js"></script>

    <!-- Your application javascript --------------------------------------->
    <script type="text/javascript">
        //test implementation prefixes
        window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
        window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
        window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange

        //Unsupported browser
        if (!window.indexedDB) {
            window.console.log("Your browser doesn't support a stable version of IndexedDB.")
        }

        //declare database 
        var userData = [];
        var data;
        var request = window.indexedDB.open("userDatabase", 1);
        userData.size = 0;
        //error handling
        request.onerror = function (event) {
            console.log("error: " + request.error);
        };
        request.onsuccess = function (event) {
            data = request.result;
        };

        //check for upgrades
        request.onupgradeneeded = function (event) {
            //Create Object Store
            data = event.target.result;
            var objectStore = data.createObjectStore("users", { keyPath: "id", autoIncrement: true });
       }

        //Create new account, add user input to database
        function register(username, password) {
            //Init user to be added
            var newUser = [{ id: userData.size+0, username: username, password: password }];
            var transaction = data.transaction(["users"], "readwrite");
            //Error handling
            transaction.onerror = function (event) {
                console.log("Error, Not opened: " + transaction.error +
                    " -> newItem id: " + newUser[0].id + " -> database size: " + userData.size);
            };
            //Init Object Store of
            var objectStore = transaction.objectStore("users");
            var objectStoreRequest = objectStore.add(newUser[0]);
            //Error handling
            objectStoreRequest.onsuccess = function (event) {
                console.log("User added. -> newItem id: " + newUser[0].id + " -> database size: " + userData.size);
                userData.size++;
            };
            objectStoreRequest.onerror = function (event) {
                console.log("User Not Added. Error: " + objectStoreRequest.error + " -> newItem id: " + newUser[0].id + " -> database size: " + userData.size);
            };
        } //End Register()

        //Login to existing account, search database for user input
        function login(username, password) {
            //Init database to reference
            var transaction = data.transaction(["users"]);
            var objectStore = transaction.objectStore("users");
            var request = objectStore.get(username);
            

            for (i = 0; i < userData.size; i++) { 
                    if (userData[i].username == username) {
                        console.log("FOUND");
                        if (userData[i].password === password)
                            goToProfile();
                }
            };
            //Error handling
            request.onerror = function (event) {
                console.log("error: " + request.error + " -> newItem id: " + request.result.id + " -> database size: " + userData.size);
            };/*
            request.onsuccess = function (event) {
                //check username against password
                console.log("checking username '" + username + "'.");
                if (password == request.result.password) {
                    //correct password, logging in....
                    console.log("correct password, logging in....");
                    goToProfile();
                }

            };//End Request*/
        }//End Login

        //Check input areas for errors
        $("#loginButton").click(function (e) {
            console.log("login pressed");
            if ($("#usernameText").val() == "")
                $("#usernameSpan").text("Enter Username");
            else
                $("#usernameSpan").text("");
            if ($("#passwordText").val() == "")
                $("#passwordSpan").text("Enter Password");
            else
                $("#passwordSpan").text("");
            if (($("#usernameText").val() != "") && ($("#passwordText").val() != "")) {
                //login($("#usernameText").val(), $("#passwordText").val());
                //Skipping authentication
                goToProfile();
            }
        });

        $("#registerButton").click(function (e) {
            console.log("register pressed");
            if ($("#regUsernameText").val() == "")
                $("#regUsernameSpan").text("Enter Username");
            else
                $("#regUsernameSpan").text("");
            if ($("#regPasswordText").val() == "")
                $("#regPasswordSpan").text("Enter Password");
            else
                $("#regPasswordSpan").text("");
            if ($("#regRptPasswordText").val() == "")
                $("#regRptPasswordSpan").text("Retype Password");
            else if ($("#regRptPasswordText").val() != $("#regPasswordText").val())
                $("#regRptPasswordSpan").text("No Match!");
            else
                $("#regRptPasswordSpan").text("");
            if (($("#regUsernameText").val() != "") && ($("#regPasswordText").val() != "") && ($("#regRptPasswordText").val() != "")) {
                register($("#regUsernameText").val(), $("#regPasswordText").val());
            }
        });

        //Go to profile page
        function goToProfile() {
            window.location.href = "messageDatabase.html";
        }
    </script> <!--End Script-->
</body >
</html >
